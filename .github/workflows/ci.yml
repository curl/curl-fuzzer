name: CI
'on':
  push:
    branches:
      - master
      - main
      - '*/ci'
  pull_request:
    branches:
      - master
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  BuildFuzzers:
    runs-on: ubuntu-latest
    steps:
    # These two checkout steps check out:
    #
    # - `curl_fuzzer` at the current ref
    # - `curl` at HEAD of the default branch
    #
    # under the `fuzz` directory.
    - name: Checkout curl fuzzer
      uses: actions/checkout@v3
      with:
        path: fuzz/curl_fuzzer
    - name: Checkout curl
      uses: actions/checkout@v3
      with:
        repository: curl/curl
        path: fuzz/curl

    # Now that the two codebases are checked out under `fuzz`,
    # use the CIFuzz steps to test them. To do this we pass
    # `project-src-path`, which overrides the codebases that
    # get checked out in the google/ossfuzz curl Dockerfile.
    - name: Build Fuzzers
      uses: google/oss-fuzz/infra/cifuzz/actions/build_fuzzers@master
      with:
        oss-fuzz-project-name: 'curl'
        dry-run: false
        project-src-path: fuzz

    # Upload all the fuzzers and their relevant files to storage for the next job.
    - name: Archive curl_fuzzer_dict
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_dict
        path: |
          build-out/curl_fuzzer_dict
          build-out/curl_fuzzer_dict_seed_corpus.zip
    - name: Archive curl_fuzzer_file
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_file
        path: |
          build-out/curl_fuzzer_file
          build-out/curl_fuzzer_file_seed_corpus.zip
    - name: Archive curl_fuzzer_ftp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_ftp
        path: |
          build-out/curl_fuzzer_ftp
          build-out/curl_fuzzer_ftp_seed_corpus.zip
    - name: Archive curl_fuzzer_gopher
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_gopher
        path: |
          build-out/curl_fuzzer_gopher
          build-out/curl_fuzzer_gopher_seed_corpus.zip
    - name: Archive curl_fuzzer_http
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_http
        path: |
          build-out/curl_fuzzer_http
          build-out/curl_fuzzer_http_seed_corpus.zip
    - name: Archive curl_fuzzer_https
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_https
        path: |
          build-out/curl_fuzzer_https
          build-out/curl_fuzzer_https_seed_corpus.zip
    - name: Archive curl_fuzzer_imap
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_imap
        path: |
          build-out/curl_fuzzer_imap
          build-out/curl_fuzzer_imap_seed_corpus.zip
    - name: Archive curl_fuzzer_ldap
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_ldap
        path: |
          build-out/curl_fuzzer_ldap
          build-out/curl_fuzzer_ldap_seed_corpus.zip
    - name: Archive curl_fuzzer_mqtt
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_mqtt
        path: |
          build-out/curl_fuzzer_mqtt
          build-out/curl_fuzzer_mqtt_seed_corpus.zip
    - name: Archive curl_fuzzer_pop3
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_pop3
        path: |
          build-out/curl_fuzzer_pop3
          build-out/curl_fuzzer_pop3_seed_corpus.zip
    - name: Archive curl_fuzzer_rtmp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_rtmp
        path: |
          build-out/curl_fuzzer_rtmp
          build-out/curl_fuzzer_rtmp_seed_corpus.zip
    - name: Archive curl_fuzzer_rtsp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_rtsp
        path: |
          build-out/curl_fuzzer_rtsp
          build-out/curl_fuzzer_rtsp_seed_corpus.zip
    - name: Archive curl_fuzzer_scp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_scp
        path: |
          build-out/curl_fuzzer_scp
          build-out/curl_fuzzer_scp_seed_corpus.zip
    - name: Archive curl_fuzzer_sftp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_sftp
        path: |
          build-out/curl_fuzzer_sftp
          build-out/curl_fuzzer_sftp_seed_corpus.zip
    - name: Archive curl_fuzzer_smb
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_smb
        path: |
          build-out/curl_fuzzer_smb
          build-out/curl_fuzzer_smb_seed_corpus.zip
    - name: Archive curl_fuzzer_smtp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_smtp
        path: |
          build-out/curl_fuzzer_smtp
          build-out/curl_fuzzer_smtp_seed_corpus.zip
    - name: Archive curl_fuzzer_tftp
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_tftp
        path: |
          build-out/curl_fuzzer_tftp
          build-out/curl_fuzzer_tftp_seed_corpus.zip
    - name: Archive curl_fuzzer_ws
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer_ws
        path: |
          build-out/curl_fuzzer_ws
          build-out/curl_fuzzer_ws_seed_corpus.zip
    - name: Archive curl_fuzzer
      uses: actions/upload-artifact@v3
      with:
        name: curl_fuzzer
        path: |
          build-out/curl_fuzzer
          build-out/curl_fuzzer_seed_corpus.zip
    - name: Archive fuzz_url
      uses: actions/upload-artifact@v3
      with:
        name: fuzz_url
        path: |
          build-out/fuzz_url
          build-out/fuzz_url_seed_corpus.zip

  RunFuzzers:
    needs: BuildFuzzers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fuzzer:
          - curl_fuzzer_dict
          - curl_fuzzer_file
          - curl_fuzzer_ftp
          - curl_fuzzer_gopher
          - curl_fuzzer_http
          - curl_fuzzer_https
          - curl_fuzzer_imap
          - curl_fuzzer_ldap
          - curl_fuzzer_mqtt
          - curl_fuzzer_pop3
          - curl_fuzzer_rtmp
          - curl_fuzzer_rtsp
          - curl_fuzzer_scp
          - curl_fuzzer_sftp
          - curl_fuzzer_smb
          - curl_fuzzer_smtp
          - curl_fuzzer_tftp
          - curl_fuzzer_ws
          - curl_fuzzer
          - fuzz_url
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.fuzzer }}
      - name: Run Fuzzer ${{ matrix.fuzzer }}
        uses: google/oss-fuzz/infra/cifuzz/actions/run_fuzzers@master
        with:
          oss-fuzz-project-name: 'curl'
          fuzz-seconds: 120
          dry-run: false
      - name: Upload Crash
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: artifacts
          path: ./out/artifacts
