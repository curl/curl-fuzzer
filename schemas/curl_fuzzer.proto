syntax = "proto3";

package curl.fuzzer.proto;

// Structured scenario description for the curl fuzzing harness. Mirrors the
// design documented in SPEC.md and is intended for consumption by
// libprotobuf-mutator powered fuzz targets as well as tooling that converts
// between legacy TLV corpora and the structured representation.

message Scenario {
  GlobalConfig global = 1;
  repeated Action actions = 2;
  repeated Connection connections = 3;
  repeated DataBlob blobs = 4;
  Metadata metadata = 5;
}

// Global options and defaults that apply before individual actions run.
message GlobalConfig {
  repeated SetOption defaults = 1;
  repeated string allowed_protocols = 2;
  uint32 timeout_ms = 3;
  uint32 server_response_timeout_ms = 4;
  bool verbose = 5;
}

message SetOption {
  CurlOptionId option_id = 1;
  OptionScope scope = 2;
  oneof value {
    string string_value = 10;
    BlobRef blob = 11;
    int32 int32_value = 12;
    uint32 uint32_value = 13;
    int64 int64_value = 14;
    uint64 uint64_value = 15;
    bool bool_value = 16;
    double double_value = 17;
  }
}

// A single configuration step executed before the transfer starts.
message Action {
  oneof kind {
    SetOption set_option = 1;
    AddHeader add_header = 2;
    AddMailRecipient add_mail_recipient = 3;
    ConfigureMime configure_mime = 4;
    ConfigureHttpPost configure_http_post = 5;
    RegisterUpload register_upload = 6;
    RegisterResponse register_response = 7;
  }
}

message AddHeader {
  HeaderValue value = 1;
}

message AddMailRecipient {
  HeaderValue value = 1;
}

message ConfigureMime {
  repeated MimePart parts = 1;
}

message ConfigureHttpPost {
  repeated FormField fields = 1;
}

message RegisterUpload {
  BlobRef payload = 1;
  TransferKind kind = 2;
  uint64 size_hint = 3;
}

message RegisterResponse {
  uint32 connection_id = 1;  // Default: 0 (primary connection)
  ResponseStage stage = 2;
  Response response = 3;
}

// Target connection behaviour once libcurl connects.
message Connection {
  uint32 id = 1;  // 0 == primary, 1 == secondary, etc.
  Response initial_response = 2;
  repeated Response on_readable = 3;
  ShutdownPolicy shutdown_policy = 4;
  OptionalDelay idle_after_send = 5;
}

message Response {
  BlobRef payload = 1;
  ResponseHint hint = 2;
  OptionalDelay delay_before = 3;
}

message ResponseHint {
  bool chunked = 1;
  bool websocket_frame = 2;
  bool tls_record = 3;
}

message OptionalDelay {
  uint32 milliseconds = 1;
}

// Canonical storage for reusable byte buffers.
message DataBlob {
  uint32 id = 1;
  oneof payload {
    bytes raw = 2;
    string utf8 = 3;
  }
  uint32 max_mutation_size = 4;
  repeated string tags = 5;
}

message BlobRef {
  uint32 blob_id = 1;
  optional uint32 offset = 2;
  optional uint32 length = 3;
}

message Metadata {
  string description = 1;
  repeated string labels = 2;
  map<string, string> annotations = 3;
  repeated string provenance = 4;
}

message HeaderValue {
  oneof value {
    string text = 1;
    BlobRef blob = 2;
  }
}

message MimePart {
  string name = 1;
  oneof body {
    BlobRef blob = 2;
    string inline_data = 3;
  }
  string filename = 4;
  string content_type = 5;
  repeated HeaderValue headers = 6;
}

message FormField {
  string name = 1;
  oneof body {
    BlobRef blob = 2;
    string inline_data = 3;
  }
  string filename = 4;
  string content_type = 5;
}

// Scope for options that support multiple namespaces (e.g. proxy vs easy).
enum OptionScope {
  OPTION_SCOPE_UNSPECIFIED = 0;
  OPTION_SCOPE_DEFAULT = 1;
  OPTION_SCOPE_PROXY = 2;
  OPTION_SCOPE_DOH = 3;
  OPTION_SCOPE_TLS = 4;
}

enum TransferKind {
  TRANSFER_KIND_UNSPECIFIED = 0;
  TRANSFER_KIND_UPLOAD = 1;
  TRANSFER_KIND_POSTFIELDS = 2;
  TRANSFER_KIND_SEND = 3;
}

enum ResponseStage {
  RESPONSE_STAGE_UNSPECIFIED = 0;
  RESPONSE_STAGE_ON_CONNECT = 1;
  RESPONSE_STAGE_ON_READABLE = 2;
}

enum ShutdownPolicy {
  SHUTDOWN_POLICY_UNSPECIFIED = 0;
  SHUTDOWN_POLICY_HALF_CLOSE_AFTER_LAST_RESPONSE = 1;
  SHUTDOWN_POLICY_KEEP_OPEN = 2;
  SHUTDOWN_POLICY_CLOSE_IMMEDIATELY = 3;
}

// Mapping of structured options to libcurl option identifiers. The enum names
// intentionally mirror libcurl's `CURLOPT_*` constants for readability.
enum CurlOptionId {
  CURL_OPTION_UNSPECIFIED = 0;
  CURLOPT_ABSTRACT_UNIX_SOCKET = 10264;
  CURLOPT_ACCEPTTIMEOUT_MS = 212;
  CURLOPT_ACCEPT_ENCODING = 10102;
  CURLOPT_ADDRESS_SCOPE = 171;
  CURLOPT_ALTSVC_CTRL = 286;
  CURLOPT_APPEND = 50;
  CURLOPT_AUTOREFERER = 58;
  CURLOPT_AWS_SIGV4 = 10305;
  CURLOPT_BUFFERSIZE = 98;
  CURLOPT_CAINFO = 10065;
  CURLOPT_CAPATH = 10097;
  CURLOPT_CA_CACHE_TIMEOUT = 321;
  CURLOPT_CERTINFO = 172;
  CURLOPT_CONNECTTIMEOUT = 78;
  CURLOPT_CONNECTTIMEOUT_MS = 156;
  CURLOPT_CONNECT_ONLY = 141;
  CURLOPT_COOKIE = 10022;
  CURLOPT_COOKIEFILE = 10031;
  CURLOPT_COOKIEJAR = 10082;
  CURLOPT_COOKIELIST = 10135;
  CURLOPT_COOKIESESSION = 96;
  CURLOPT_CUSTOMREQUEST = 10036;
  CURLOPT_DEFAULT_PROTOCOL = 10238;
  CURLOPT_DIRLISTONLY = 48;
  CURLOPT_DISALLOW_USERNAME_IN_URL = 278;
  CURLOPT_DNS_CACHE_TIMEOUT = 92;
  CURLOPT_DNS_INTERFACE = 10221;
  CURLOPT_DNS_LOCAL_IP4 = 10222;
  CURLOPT_DNS_LOCAL_IP6 = 10223;
  CURLOPT_DNS_SERVERS = 10211;
  CURLOPT_DNS_SHUFFLE_ADDRESSES = 275;
  CURLOPT_DOH_SSL_VERIFYHOST = 307;
  CURLOPT_DOH_SSL_VERIFYPEER = 306;
  CURLOPT_DOH_SSL_VERIFYSTATUS = 308;
  CURLOPT_DOH_URL = 10279;
  CURLOPT_ECH = 10325;
  CURLOPT_EXPECT_100_TIMEOUT_MS = 227;
  CURLOPT_FAILONERROR = 45;
  CURLOPT_FILETIME = 69;
  CURLOPT_FOLLOWLOCATION = 52;
  CURLOPT_FORBID_REUSE = 75;
  CURLOPT_FRESH_CONNECT = 74;
  CURLOPT_FTPPORT = 10017;
  CURLOPT_FTPSSLAUTH = 129;
  CURLOPT_FTP_ACCOUNT = 10134;
  CURLOPT_FTP_ALTERNATIVE_TO_USER = 10147;
  CURLOPT_FTP_CREATE_MISSING_DIRS = 110;
  CURLOPT_FTP_FILEMETHOD = 138;
  CURLOPT_FTP_SKIP_PASV_IP = 137;
  CURLOPT_FTP_SSL_CCC = 154;
  CURLOPT_FTP_USE_EPRT = 106;
  CURLOPT_FTP_USE_EPSV = 85;
  CURLOPT_FTP_USE_PRET = 188;
  CURLOPT_GSSAPI_DELEGATION = 210;
  CURLOPT_HAPPY_EYEBALLS_TIMEOUT_MS = 271;
  CURLOPT_HAPROXYPROTOCOL = 274;
  CURLOPT_HAPROXY_CLIENT_IP = 10323;
  CURLOPT_HEADER = 42;
  CURLOPT_HEADEROPT = 229;
  CURLOPT_HSTS_CTRL = 299;
  CURLOPT_HTTP09_ALLOWED = 285;
  CURLOPT_HTTPAUTH = 107;
  CURLOPT_HTTPGET = 80;
  CURLOPT_HTTPPOST = 10024;
  CURLOPT_HTTPPROXYTUNNEL = 61;
  CURLOPT_HTTP_CONTENT_DECODING = 158;
  CURLOPT_HTTP_TRANSFER_DECODING = 157;
  CURLOPT_HTTP_VERSION = 84;
  CURLOPT_IGNORE_CONTENT_LENGTH = 136;
  CURLOPT_INFILESIZE_LARGE = 30115;
  CURLOPT_INTERFACE = 10062;
  CURLOPT_IPRESOLVE = 113;
  CURLOPT_ISSUERCERT = 10170;
  CURLOPT_KEEP_SENDING_ON_ERROR = 245;
  CURLOPT_KEYPASSWD = 10026;
  CURLOPT_KRBLEVEL = 10063;
  CURLOPT_LOCALPORT = 139;
  CURLOPT_LOCALPORTRANGE = 140;
  CURLOPT_LOGIN_OPTIONS = 10224;
  CURLOPT_LOW_SPEED_LIMIT = 19;
  CURLOPT_LOW_SPEED_TIME = 20;
  CURLOPT_MAIL_AUTH = 10217;
  CURLOPT_MAIL_FROM = 10186;
  CURLOPT_MAIL_RCPT_ALLOWFAILS = 290;
  CURLOPT_MAXAGE_CONN = 288;
  CURLOPT_MAXCONNECTS = 71;
  CURLOPT_MAXFILESIZE = 114;
  CURLOPT_MAXFILESIZE_LARGE = 30117;
  CURLOPT_MAXLIFETIME_CONN = 314;
  CURLOPT_MAXREDIRS = 68;
  CURLOPT_MAX_RECV_SPEED_LARGE = 30146;
  CURLOPT_MAX_SEND_SPEED_LARGE = 30145;
  CURLOPT_MIMEPOST = 10269;
  CURLOPT_MIME_OPTIONS = 315;
  CURLOPT_NETRC = 51;
  CURLOPT_NEW_DIRECTORY_PERMS = 160;
  CURLOPT_NEW_FILE_PERMS = 159;
  CURLOPT_NOBODY = 44;
  CURLOPT_NOPROGRESS = 43;
  CURLOPT_NOPROXY = 10177;
  CURLOPT_NOSIGNAL = 99;
  CURLOPT_PASSWORD = 10174;
  CURLOPT_PATH_AS_IS = 234;
  CURLOPT_PINNEDPUBLICKEY = 10230;
  CURLOPT_PIPEWAIT = 237;
  CURLOPT_PORT = 3;
  CURLOPT_POST = 47;
  CURLOPT_POSTFIELDS = 10015;
  CURLOPT_POSTFIELDSIZE = 60;
  CURLOPT_POSTFIELDSIZE_LARGE = 30120;
  CURLOPT_POSTREDIR = 161;
  CURLOPT_PRE_PROXY = 10262;
  CURLOPT_PROXY = 10004;
  CURLOPT_PROXYAUTH = 111;
  CURLOPT_PROXYPASSWORD = 10176;
  CURLOPT_PROXYPORT = 59;
  CURLOPT_PROXYTYPE = 101;
  CURLOPT_PROXYUSERNAME = 10175;
  CURLOPT_PROXYUSERPWD = 10006;
  CURLOPT_PROXY_CAINFO = 10246;
  CURLOPT_PROXY_CAPATH = 10247;
  CURLOPT_PROXY_CRLFILE = 10260;
  CURLOPT_PROXY_ISSUERCERT = 10296;
  CURLOPT_PROXY_KEYPASSWD = 10258;
  CURLOPT_PROXY_PINNEDPUBLICKEY = 10263;
  CURLOPT_PROXY_SERVICE_NAME = 10235;
  CURLOPT_PROXY_SSLCERT = 10254;
  CURLOPT_PROXY_SSLCERTTYPE = 10255;
  CURLOPT_PROXY_SSLKEY = 10256;
  CURLOPT_PROXY_SSLKEYTYPE = 10257;
  CURLOPT_PROXY_SSLVERSION = 250;
  CURLOPT_PROXY_SSL_CIPHER_LIST = 10259;
  CURLOPT_PROXY_SSL_OPTIONS = 261;
  CURLOPT_PROXY_SSL_VERIFYHOST = 249;
  CURLOPT_PROXY_SSL_VERIFYPEER = 248;
  CURLOPT_PROXY_TLS13_CIPHERS = 10277;
  CURLOPT_PROXY_TLSAUTH_PASSWORD = 10252;
  CURLOPT_PROXY_TLSAUTH_TYPE = 10253;
  CURLOPT_PROXY_TLSAUTH_USERNAME = 10251;
  CURLOPT_PROXY_TRANSFER_MODE = 166;
  CURLOPT_QUICK_EXIT = 322;
  CURLOPT_RANGE = 10007;
  CURLOPT_REDIR_PROTOCOLS_STR = 10319;
  CURLOPT_REFERER = 10016;
  CURLOPT_REQUEST_TARGET = 10266;
  CURLOPT_RESUME_FROM = 21;
  CURLOPT_RESUME_FROM_LARGE = 30116;
  CURLOPT_RTSP_CLIENT_CSEQ = 193;
  CURLOPT_RTSP_REQUEST = 189;
  CURLOPT_RTSP_SERVER_CSEQ = 194;
  CURLOPT_RTSP_SESSION_ID = 10190;
  CURLOPT_RTSP_STREAM_URI = 10191;
  CURLOPT_RTSP_TRANSPORT = 10192;
  CURLOPT_SASL_AUTHZID = 10289;
  CURLOPT_SASL_IR = 218;
  CURLOPT_SERVER_RESPONSE_TIMEOUT_MS = 324;
  CURLOPT_SERVICE_NAME = 10236;
  CURLOPT_SOCKS5_AUTH = 267;
  CURLOPT_SOCKS5_GSSAPI_NEC = 180;
  CURLOPT_SSH_AUTH_TYPES = 151;
  CURLOPT_SSH_COMPRESSION = 268;
  CURLOPT_SSH_HOST_PUBLIC_KEY_MD5 = 10162;
  CURLOPT_SSH_HOST_PUBLIC_KEY_SHA256 = 10311;
  CURLOPT_SSH_KNOWNHOSTS = 10183;
  CURLOPT_SSH_PRIVATE_KEYFILE = 10153;
  CURLOPT_SSH_PUBLIC_KEYFILE = 10152;
  CURLOPT_SSLCERT = 10025;
  CURLOPT_SSLCERTTYPE = 10086;
  CURLOPT_SSLENGINE = 10089;
  CURLOPT_SSLENGINE_DEFAULT = 90;
  CURLOPT_SSLKEY = 10087;
  CURLOPT_SSLKEYTYPE = 10088;
  CURLOPT_SSLVERSION = 32;
  CURLOPT_SSL_CIPHER_LIST = 10083;
  CURLOPT_SSL_EC_CURVES = 10298;
  CURLOPT_SSL_ENABLE_ALPN = 226;
  CURLOPT_SSL_FALSESTART = 233;
  CURLOPT_SSL_OPTIONS = 216;
  CURLOPT_SSL_SESSIONID_CACHE = 150;
  CURLOPT_SSL_VERIFYHOST = 81;
  CURLOPT_SSL_VERIFYPEER = 64;
  CURLOPT_SSL_VERIFYSTATUS = 232;
  CURLOPT_STREAM_WEIGHT = 239;
  CURLOPT_SUPPRESS_CONNECT_HEADERS = 265;
  CURLOPT_TCP_FASTOPEN = 244;
  CURLOPT_TCP_KEEPALIVE = 213;
  CURLOPT_TCP_KEEPCNT = 326;
  CURLOPT_TCP_KEEPIDLE = 214;
  CURLOPT_TCP_KEEPINTVL = 215;
  CURLOPT_TCP_NODELAY = 121;
  CURLOPT_TFTP_BLKSIZE = 178;
  CURLOPT_TFTP_NO_OPTIONS = 242;
  CURLOPT_TIMECONDITION = 33;
  CURLOPT_TIMEVALUE = 34;
  CURLOPT_TIMEVALUE_LARGE = 30270;
  CURLOPT_TLS13_CIPHERS = 10276;
  CURLOPT_TLSAUTH_PASSWORD = 10205;
  CURLOPT_TLSAUTH_TYPE = 10206;
  CURLOPT_TLSAUTH_USERNAME = 10204;
  CURLOPT_TRANSFERTEXT = 53;
  CURLOPT_TRANSFER_ENCODING = 207;
  CURLOPT_UNIX_SOCKET_PATH = 10231;
  CURLOPT_UNRESTRICTED_AUTH = 105;
  CURLOPT_UPKEEP_INTERVAL_MS = 281;
  CURLOPT_UPLOAD = 46;
  CURLOPT_UPLOAD_BUFFERSIZE = 280;
  CURLOPT_URL = 10002;
  CURLOPT_USERAGENT = 10018;
  CURLOPT_USERNAME = 10173;
  CURLOPT_USERPWD = 10005;
  CURLOPT_USE_SSL = 119;
  CURLOPT_WILDCARDMATCH = 197;
  CURLOPT_WS_OPTIONS = 320;
  CURLOPT_XOAUTH2_BEARER = 10220;
}
